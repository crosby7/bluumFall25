openapi: 3.0.3
info:
  title: Bluum Patient API
  description: |
    Essential API endpoints for the Bluum patient application.

    **Scope:** This specification documents only the patient-facing mobile/web API endpoints.
    The Nurse Portal API (`/api/nurse/*`) is not included in this specification.

    **Authentication:** All authenticated endpoints use Laravel Sanctum bearer tokens obtained via the `/login` endpoint.

    **Rate Limiting:**
    - `/login` endpoint: Protected by `throttle:auth` middleware
    - All other authenticated endpoints: Protected by `throttle:patient-api` middleware

    **Avatar System:**
    Each patient has an avatar composed of multiple layered images. When a patient object is returned with the `avatar` relationship loaded,
    you'll receive an array of layer images ordered by `layer_number`. To render the avatar:
    1. Load all layer images
    2. Stack them in order (layer 1 = bottom, higher numbers on top)
    3. Composite them together like Photoshop layers

    Available avatars:
    - **Axolotl** (5 layers) - A cute axolotl avatar
    - **Corgi** (7 layers) - A cheerful corgi avatar (default for new patients)

    All avatars are freely available to patients without purchase.
  version: 0.1.0
  contact:
    name: Bluum Development Team

servers:
  - url: http://localhost:8000/api
    description: Local development server

tags:
  - name: Authentication
    description: Patient authentication endpoints
  - name: Profile
    description: Patient profile management
  - name: Tasks
    description: Patient task operations
  - name: Inventory
    description: Patient inventory management
  - name: Shop
    description: Shop items available for purchase

paths:
  /login:
    post:
      tags:
        - Authentication
      summary: Patient login via pairing code
      description: |
        Authenticate a patient using a 6-digit pairing code and receive a bearer token.

        **Note:** This endpoint revokes all existing tokens for the patient to enforce single-device login.
        Remove this behavior in the implementation if multi-device support is needed.

        **Rate Limiting:** This endpoint is protected by the `throttle:auth` middleware.
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - pairing_code
              properties:
                pairing_code:
                  type: string
                  minLength: 6
                  maxLength: 6
                  pattern: '^\d{6}$'
                  description: 6-digit numeric pairing code
                  example: "123456"
                device_identifier:
                  type: string
                  nullable: true
                  description: Optional device identifier for tracking which device the patient is using
                  example: "iPhone 14 - iOS 17.1"
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                    description: Bearer token for API authentication (Sanctum token)
                    example: 1|abc123def456...
                  patient:
                    $ref: '#/components/schemas/Patient'
        '422':
          description: Invalid pairing code
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
              example:
                message: The given data was invalid.
                errors:
                  pairing_code:
                    - The provided pairing code is incorrect.
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /logout:
    post:
      tags:
        - Authentication
      summary: Patient logout
      description: |
        Revoke the current authentication token.

        **Rate Limiting:** This endpoint is protected by the `throttle:patient-api` middleware.
      operationId: logout
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Logout successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Logged out successfully
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /me:
    get:
      tags:
        - Authentication
      summary: Get authenticated patient
      description: |
        Retrieve the currently authenticated patient's information.

        **Rate Limiting:** This endpoint is protected by the `throttle:patient-api` middleware.
      operationId: getCurrentPatient
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Patient information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Patient'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /patient:
    get:
      tags:
        - Authentication
      summary: Get authenticated patient (alias)
      description: |
        Retrieve the currently authenticated patient's information.

        **Note:** This endpoint is functionally identical to `/me` and returns the same data.

        **Rate Limiting:** This endpoint is protected by the `throttle:patient-api` middleware.
      operationId: getPatient
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Patient information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Patient'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /patient/profile:
    get:
      tags:
        - Profile
      summary: Get patient profile
      description: |
        Retrieve the authenticated patient's full profile with stats.

        **Rate Limiting:** This endpoint is protected by the `throttle:patient-api` middleware.
      operationId: getProfile
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Patient profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PatientProfile'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalServerError'

    patch:
      tags:
        - Profile
      summary: Update patient profile
      description: |
        Update the authenticated patient's profile information.

        All fields are optional - only provide the fields you want to update.

        **Rate Limiting:** This endpoint is protected by the `throttle:patient-api` middleware.
      operationId: updateProfile
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                username:
                  type: string
                  maxLength: 255
                  description: New username for the patient
                  example: coolpatient123
                avatar_id:
                  type: integer
                  minimum: 1
                  description: ID of the avatar to use (must be at least 1)
                  example: 5
      responses:
        '200':
          description: Profile updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Profile updated successfully
                  patient:
                    $ref: '#/components/schemas/Patient'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /patient/tasks/current:
    get:
      tags:
        - Tasks
      summary: Get current tasks
      description: |
        Retrieve tasks scheduled for today for the authenticated patient.

        **Rate Limiting:** This endpoint is protected by the `throttle:patient-api` middleware.
      operationId: getCurrentTasks
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of current tasks
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/TaskCompletion'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /patient/tasks/completions/{taskCompletion}:
    patch:
      tags:
        - Tasks
      summary: Update task completion status
      description: |
        Update the status of a task completion for the authenticated patient.
        Patients can only update their own task completions.

        **Rate Limiting:** This endpoint is protected by the `throttle:patient-api` middleware.
      operationId: updateTaskCompletion
      security:
        - bearerAuth: []
      parameters:
        - name: taskCompletion
          in: path
          required: true
          description: ID of the task completion to update
          schema:
            type: integer
            example: 1
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                status:
                  type: string
                  description: New status for the task
                  enum: [pending, completed, skipped, failed]
                  example: completed
                completed_at:
                  type: string
                  format: date-time
                  nullable: true
                  description: Timestamp when the task was completed (optional, will be set automatically if status is completed)
                  example: '2024-01-20T14:30:00.000000Z'
      responses:
        '200':
          description: Task completion updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/TaskCompletion'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Forbidden - patient cannot update this task completion
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: This action is unauthorized.
        '404':
          description: Task completion not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Task completion not found.
        '422':
          $ref: '#/components/responses/ValidationError'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /patient/inventory:
    get:
      tags:
        - Inventory
      summary: Get patient inventory
      description: |
        Retrieve the authenticated patient's inventory items.

        **Rate Limiting:** This endpoint is protected by the `throttle:patient-api` middleware.
      operationId: getInventory
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Patient inventory
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/PatientItem'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /items:
    get:
      tags:
        - Shop
      summary: Get shop items
      description: |
        Retrieve all items available for purchase in the shop.

        **Rate Limiting:** This endpoint is protected by the `throttle:patient-api` middleware.
      operationId: getShopItems
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of shop items
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Item'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalServerError'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      description: |
        Laravel Sanctum token obtained from the login endpoint.
        Include in the Authorization header as: Bearer {token}

  schemas:
    Patient:
      type: object
      description: Patient model with authentication via pairing code
      required:
        - id
        - username
        - experience
        - gems
      properties:
        id:
          type: integer
          description: Unique identifier for the patient
          example: 1
        username:
          type: string
          description: Patient's username
          maxLength: 255
          example: patient123
        pairing_code:
          type: string
          nullable: true
          description: 6-digit numeric code used for authentication. Null after successful pairing.
          minLength: 6
          maxLength: 6
          pattern: '^\d{6}$'
          example: "123456"
        paired_at:
          type: string
          format: date-time
          nullable: true
          description: Timestamp when the patient last paired/logged in
          example: '2024-01-20T14:30:00.000000Z'
        avatar_id:
          type: integer
          nullable: true
          description: ID of the avatar selected by the patient
          example: 2
        avatar:
          description: The patient's avatar with all layer images (only present when avatar relationship is loaded)
          allOf:
            - $ref: '#/components/schemas/Avatar'
        experience:
          type: integer
          description: Patient's total XP earned from completing tasks
          minimum: 0
          example: 250
        gems:
          type: integer
          description: Patient's total gems earned from completing tasks
          minimum: 0
          example: 50
        device_identifier:
          type: string
          nullable: true
          description: Unique identifier for the patient's device
          example: "iPhone 14 - iOS 17.1"
        created_at:
          type: string
          format: date-time
          description: Timestamp when the patient record was created
          example: '2024-01-15T10:30:00.000000Z'
        updated_at:
          type: string
          format: date-time
          description: Timestamp when the patient record was last updated
          example: '2024-01-20T14:30:00.000000Z'

    PatientProfile:
      type: object
      description: Extended patient profile with additional statistics
      properties:
        id:
          type: integer
          example: 1
        username:
          type: string
          example: patient123
        avatar_id:
          type: integer
          nullable: true
          description: ID of the avatar selected by the patient
          example: 2
        avatar:
          description: The patient's avatar with all layer images (only present when avatar relationship is loaded)
          allOf:
            - $ref: '#/components/schemas/Avatar'
        experience:
          type: integer
          description: Patient's total XP
          example: 250
        gems:
          type: integer
          description: Patient's total gems
          example: 50
        created_at:
          type: string
          format: date-time
          example: '2024-01-15T10:30:00.000000Z'
        stats:
          type: object
          properties:
            total_xp:
              type: integer
              example: 250
            total_gems:
              type: integer
              example: 50
            active_subscriptions:
              type: integer
              description: Number of active task subscriptions
              example: 5
            tasks_completed_today:
              type: integer
              example: 3
            tasks_completed_this_week:
              type: integer
              example: 18
            tasks_completed_total:
              type: integer
              example: 127
            current_streak:
              type: integer
              description: Consecutive days with completed tasks
              example: 7

    Avatar:
      type: object
      description: Avatar model with layered images for compositing
      required:
        - id
        - name
        - base_path
        - layer_count
        - is_default
      properties:
        id:
          type: integer
          description: Unique identifier for the avatar
          example: 2
        name:
          type: string
          description: Name of the avatar type
          example: Corgi
        description:
          type: string
          nullable: true
          description: Description of the avatar
          example: A cheerful corgi avatar
        base_path:
          type: string
          description: Base path to the avatar images directory
          example: assets/Avatar/Corgi
        layer_count:
          type: integer
          description: Total number of layers for this avatar
          example: 7
        is_default:
          type: boolean
          description: Whether this is the default avatar assigned to new patients
          example: true
        layers:
          type: array
          description: Array of layer images ordered by layer_number. Stack these images on top of each other to render the complete avatar (layer 1 = bottom).
          items:
            $ref: '#/components/schemas/AvatarLayer'

    AvatarLayer:
      type: object
      description: Individual layer image for avatar compositing
      required:
        - id
        - layer_number
        - layer_name
        - image_path
      properties:
        id:
          type: integer
          description: Unique identifier for the layer
          example: 6
        layer_number:
          type: integer
          description: Order of the layer (1 is bottom, higher numbers stack on top)
          example: 1
        layer_name:
          type: string
          description: Name of the layer
          example: FirstLayer
        image_path:
          type: string
          description: Full path to the layer image file
          example: assets/Avatar/Corgi/Corgi_FirstLayer.png

    Task:
      type: object
      required:
        - id
        - name
        - xp_value
        - gem_value
      properties:
        id:
          type: integer
          example: 1
        name:
          type: string
          example: Take Morning Medication
        description:
          type: string
          nullable: true
          example: Take 2 pills with water
        xp_value:
          type: integer
          description: Experience points awarded for completing this task
          example: 10
        gem_value:
          type: integer
          description: Gems awarded for completing this task
          example: 5
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    TaskCompletion:
      type: object
      required:
        - id
        - subscription_id
        - scheduled_for
        - status
        - task
        - subscription
      properties:
        id:
          type: integer
          example: 1
        subscription_id:
          type: integer
          example: 5
        scheduled_for:
          type: string
          format: date-time
          description: When this task is scheduled to be completed
          example: '2024-01-20T08:00:00.000000Z'
        completed_at:
          type: string
          format: date-time
          nullable: true
          description: When the task was actually completed
          example: null
        status:
          type: string
          description: Task completion status
          enum: [pending, completed, skipped, failed]
          example: pending
        task:
          $ref: '#/components/schemas/TaskSummary'
        subscription:
          $ref: '#/components/schemas/Subscription'

    Item:
      type: object
      required:
        - id
        - name
        - price
      properties:
        id:
          type: integer
          example: 1
        name:
          type: string
          example: Cool Avatar
        description:
          type: string
          nullable: true
          example: A really cool avatar for your profile
        price:
          type: integer
          description: Price in gems
          example: 100
        image:
          type: string
          nullable: true
          description: URL or path to item image
          example: /images/items/avatar-1.png
        category:
          type: string
          nullable: true
          example: avatar

    TaskSummary:
      type: object
      description: Simplified task object without timestamps (used in nested responses)
      required:
        - id
        - name
        - xp_value
        - gem_value
      properties:
        id:
          type: integer
          description: Unique identifier for the task
          example: 1
        name:
          type: string
          description: Name of the task
          example: Take Morning Medication
        description:
          type: string
          nullable: true
          description: Detailed description of the task
          example: Take 2 pills with water
        xp_value:
          type: integer
          description: Experience points awarded for completing this task
          example: 10
        gem_value:
          type: integer
          description: Gems awarded for completing this task
          example: 5

    ItemSummary:
      type: object
      description: Simplified item object (used in nested responses)
      required:
        - id
        - name
        - price
      properties:
        id:
          type: integer
          description: Unique identifier for the item
          example: 5
        name:
          type: string
          description: Name of the item
          example: Cool Avatar
        description:
          type: string
          nullable: true
          description: Description of the item
          example: A really cool avatar for your profile
        price:
          type: integer
          description: Price of the item in gems
          example: 100
        image:
          type: string
          nullable: true
          description: URL or path to item image
          example: /images/items/avatar-1.png
        category:
          type: string
          nullable: true
          description: Item category
          example: avatar

    Subscription:
      type: object
      description: Task subscription information
      required:
        - interval_days
        - is_active
      properties:
        interval_days:
          type: integer
          description: How often the task repeats (in days)
          example: 1
        timezone:
          type: string
          description: Timezone for task scheduling
          example: America/New_York
        is_active:
          type: boolean
          description: Whether this subscription is currently active
          example: true

    PatientItem:
      type: object
      required:
        - patient_id
        - item_id
        - equipped
        - item
      properties:
        patient_id:
          type: integer
          example: 1
        item_id:
          type: integer
          example: 5
        equipped:
          type: boolean
          description: Whether this item is currently equipped
          example: true
        item:
          $ref: '#/components/schemas/ItemSummary'

    ValidationError:
      type: object
      properties:
        message:
          type: string
          example: The given data was invalid.
        errors:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
          example:
            email:
              - The provided credentials are incorrect.

  responses:
    Unauthorized:
      description: Unauthorized - Invalid or missing authentication token
      content:
        application/json:
          schema:
            type: object
            properties:
              message:
                type: string
                example: Unauthenticated.

    TooManyRequests:
      description: Too Many Requests - Rate limit exceeded
      headers:
        Retry-After:
          description: Number of seconds to wait before retrying
          schema:
            type: integer
          example: 60
        X-RateLimit-Limit:
          description: The maximum number of requests allowed in the time window
          schema:
            type: integer
          example: 60
        X-RateLimit-Remaining:
          description: The number of requests remaining in the current time window
          schema:
            type: integer
          example: 0
      content:
        application/json:
          schema:
            type: object
            properties:
              message:
                type: string
                example: Too Many Attempts.

    ValidationError:
      description: Validation error - Invalid request data
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ValidationError'

    InternalServerError:
      description: Internal Server Error
      content:
        application/json:
          schema:
            type: object
            properties:
              message:
                type: string
                example: Server Error
